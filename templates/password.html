{% extends "layout.html" %}

{% block title %}SecureVault - Générateur{% endblock %}

{% block nav_generator %}active{% endblock %}

{% block content %}
    <div class="content-header">
        <h1>Générateur de mots de passe</h1>
    </div>
    
    <div class="passwords-container">
        <div class="password-card">
            <!-- Message d'erreur -->
            <div id="error-message" class="error-message" style="display: none;">
                Veuillez sélectionner au moins un type de caractère !
            </div>

            <h4>Veuillez choisir les caractéristiques de votre mot de passe</h4>

            <div class="password-options">
                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="uppercase" checked>
                        <span class="checkmark"></span>
                        Majuscules (A-Z)
                    </label>
                </div>

                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="lowercase" checked>
                        <span class="checkmark"></span>
                        Minuscules (a-z)
                    </label>
                </div>

                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="numbers" checked>
                        <span class="checkmark"></span>
                        Chiffres (0-9)
                    </label>
                </div>

                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="symbols">
                        <span class="checkmark"></span>
                        Caractères spéciaux (!@#$%^&*)
                    </label>
                </div>

                <div class="option-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="exclude-similar" checked>
                        <span class="checkmark"></span>
                        Exclure les caractères similaires (0, O, l, 1)
                    </label>
                </div>

                <div class="length-group">
                    <label>Longueur du mot de passe:</label>
                    <div class="length-controls">
                        <button type="button" class="length-btn" id="decrease">-</button>
                        <span class="length-display" id="length">12</span>
                        <button type="button" class="length-btn" id="increase">+</button>
                    </div>
                </div>
            </div>

            <div class="password-result">
                <input type="text" id="generated-password" class="password-display" readonly placeholder="Cliquez sur 'Générer' pour créer un mot de passe">
            </div>

            <div class="strength-meter">
                <div class="strength-label">Force du mot de passe:</div>
                <div class="strength-bar">
                    <div class="strength-fill" id="strength-fill"></div>
                </div>
                <div class="strength-text" id="strength-text">Aucun mot de passe</div>
            </div>

            <div class="button-group">
                <button type="button" class="btn generate-btn" id="generate">
                    <i class="fas fa-sync-alt"></i> Générer
                </button>
                <button type="button" class="btn copy-btn" id="copy" disabled>
                    <i class="fas fa-copy"></i> Copier
                </button>
                <a href="/dashboard">
                    <button type="button" class="btn done-btn">
                        <i class="fas fa-check"></i> Terminé
                    </button>
                </a>
            </div>

            <!-- Message de notification pour la copie -->
            <div id="copy-notification" class="copy-notification" style="display: none;">
                <i class="fas fa-check-circle"></i>
                Mot de passe copié dans le presse-papiers !
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentPassword = '';
        let currentStrength = null;

        // Éléments DOM
        const uppercaseCheckbox = document.getElementById('uppercase');
        const lowercaseCheckbox = document.getElementById('lowercase');
        const numbersCheckbox = document.getElementById('numbers');
        const symbolsCheckbox = document.getElementById('symbols');
        const excludeSimilarCheckbox = document.getElementById('exclude-similar');
        const lengthDisplay = document.getElementById('length');
        const decreaseBtn = document.getElementById('decrease');
        const increaseBtn = document.getElementById('increase');
        const generateBtn = document.getElementById('generate');
        const copyBtn = document.getElementById('copy');
        const passwordInput = document.getElementById('generated-password');
        const strengthFill = document.getElementById('strength-fill');
        const strengthText = document.getElementById('strength-text');
        const copyNotification = document.getElementById('copy-notification');

        // Gestion de la longueur du mot de passe
        function updateLength(change) {
            let currentLength = parseInt(lengthDisplay.textContent);
            let newLength = currentLength + change;

            // Limite entre 4 et 128 caractères
            if (newLength >= 4 && newLength <= 128) {
                lengthDisplay.textContent = newLength;

                // Génère automatiquement un nouveau mot de passe si on en a déjà un
                if (currentPassword) {
                    generatePassword();
                }
            }
        }

        // Validation des options sélectionnées
        function validateOptions() {
            const anySelected = uppercaseCheckbox.checked ||
                              lowercaseCheckbox.checked ||
                              numbersCheckbox.checked ||
                              symbolsCheckbox.checked;

            const errorMessage = document.getElementById('error-message');
            
            if (!anySelected) {
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 4000);
                return false;
            } else {
                errorMessage.style.display = 'none';
            }
            return true;
        }

        // Génération du mot de passe via l'API
        async function generatePassword() {
            if (!validateOptions()) return;

            // Désactive le bouton pendant la génération
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';

            try {
                const options = {
                    length: parseInt(lengthDisplay.textContent),
                    use_uppercase: uppercaseCheckbox.checked,
                    use_lowercase: lowercaseCheckbox.checked,
                    use_digits: numbersCheckbox.checked,
                    use_special: symbolsCheckbox.checked,
                    exclude_similar: excludeSimilarCheckbox.checked
                };

                const response = await fetch('/api/generate-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(options)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expirée. Veuillez vous reconnecter.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Erreur ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Met à jour l'interface
                currentPassword = data.password;
                currentStrength = data.strength;
                passwordInput.value = currentPassword;
                updateStrengthMeter(currentStrength);

                // Active le bouton de copie
                copyBtn.disabled = false;

            } catch (error) {
                console.error('Erreur lors de la génération:', error);
                alert('Erreur lors de la génération du mot de passe: ' + error.message);
                passwordInput.value = '';
                currentPassword = '';
                copyBtn.disabled = true;
                updateStrengthMeter(null);
            } finally {
                // Réactive le bouton
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Générer';
            }
        }

        // Mise à jour du compteur de force
        function updateStrengthMeter(strength) {
            if (!strength) {
                strengthFill.style.width = '0%';
                strengthFill.className = 'strength-fill';
                strengthText.textContent = 'Aucun mot de passe';
                return;
            }

            const score = strength.score;
            const level = strength.level;

            strengthFill.style.width = score + '%';
            strengthText.textContent = `${level} (${score}%)`;

            // Change la couleur selon le niveau
            strengthFill.className = 'strength-fill';
            if (score >= 80) {
                strengthFill.classList.add('very-strong');
            } else if (score >= 60) {
                strengthFill.classList.add('strong');
            } else if (score >= 40) {
                strengthFill.classList.add('medium');
            } else if (score >= 20) {
                strengthFill.classList.add('weak');
            } else {
                strengthFill.classList.add('very-weak');
            }
        }

        // Fonction de copie dans le presse-papiers
        async function copyToClipboard() {
            if (!currentPassword) return;

            try {
                await navigator.clipboard.writeText(currentPassword);
                showCopyNotification();
            } catch (err) {
                // Fallback pour les navigateurs plus anciens
                passwordInput.select();
                document.execCommand('copy');
                showCopyNotification();
            }
        }

        // Affiche la notification de copie
        function showCopyNotification() {
            copyNotification.style.display = 'block';
            copyNotification.classList.add('show');

            setTimeout(() => {
                copyNotification.classList.remove('show');
                setTimeout(() => {
                    copyNotification.style.display = 'none';
                }, 300);
            }, 2000);
        }

        // Analyse la force d'un mot de passe personnalisé
        async function analyzePasswordStrength(password) {
            if (!password) {
                updateStrengthMeter(null);
                return;
            }

            try {
                const response = await fetch('/api/check-password-strength', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStrengthMeter(data.strength);
                }
            } catch (error) {
                console.error('Erreur lors de l\'analyse:', error);
            }
        }

        // Event Listeners
        decreaseBtn.addEventListener('click', () => updateLength(-1));
        increaseBtn.addEventListener('click', () => updateLength(1));
        generateBtn.addEventListener('click', generatePassword);
        copyBtn.addEventListener('click', copyToClipboard);

        // Génération automatique quand les options changent
        [uppercaseCheckbox, lowercaseCheckbox, numbersCheckbox, symbolsCheckbox, excludeSimilarCheckbox].forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (currentPassword) {
                    generatePassword();
                }
            });
        });

        // Analyse en temps réel si l'utilisateur tape dans le champ
        passwordInput.addEventListener('input', (e) => {
            const value = e.target.value;
            if (value !== currentPassword) {
                currentPassword = value;
                analyzePasswordStrength(value);
                copyBtn.disabled = !value;
            }
        });

        // Raccourci clavier pour générer (Ctrl+G ou Cmd+G)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                e.preventDefault();
                generatePassword();
            }
            // Raccourci pour copier (Ctrl+C ou Cmd+C) quand le focus n'est pas sur l'input
            if ((e.ctrlKey || e.metaKey) && e.key === 'c' && document.activeElement !== passwordInput && currentPassword) {
                e.preventDefault();
                copyToClipboard();
            }
        });

        // Génère un mot de passe initial au chargement de la page
        window.addEventListener('load', () => {
            setTimeout(generatePassword, 500);
        });
    </script>
{% endblock %}

{% extends "layout.html" %}

{% block title %}SecureVault - Paramètres{% endblock %}

{% block nav_settings %}active{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Paramètres</h1>
</div>

<div class="settings-container">
    <!-- Section Compte -->
    <div class="settings-section">
        <h2><i class="fas fa-user"></i> Compte</h2>
        
        <div class="setting-item">
            <div class="setting-info">
                <h3>Nom d'utilisateur: <strong id="username-display">-</strong> 
                    <button class="btn-icon" id="change-username" title="Modifier le nom d'utilisateur">
                        <i class="fas fa-edit"></i>
                    </button>
                </h3>
            </div>
        </div>
    </div>

    <!-- Section Sécurité -->
    <div class="settings-section">
        <h2><i class="fas fa-shield-alt"></i> Sécurité</h2>
        
        <div class="setting-item">
            <div class="setting-info">
                <h3>Changer le mot de passe maître</h3>
                <p>Modifiez votre mot de passe maître pour sécuriser vos données</p>
            </div>
            <button class="btn btn-primary" id="change-master-password">
                <i class="fas fa-key"></i>
                Modifier
            </button>
        </div>

        <div class="setting-item">
            <div class="setting-info">
                <h3>Verrouillage automatique</h3>
                <p>Temps d'inactivité avant verrouillage automatique</p>
            </div>
            <select class="form-input" id="auto-lock-time" style="width: 150px;">
                <option value="5">5 minutes</option>
                <option value="15" selected>15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 heure</option>
                <option value="0">Jamais</option>
            </select>
        </div>

        <div class="setting-item">
            <div class="setting-info">
                <h3>Sessions actives</h3>
                <p>Gérez vos sessions de connexion actives</p>
            </div>
            <button class="btn btn-secondary" id="logout-all-sessions">
                <i class="fas fa-sign-out-alt"></i>
                Déconnecter partout
            </button>
        </div>
    </div>

    <!-- Section Suppression de compte -->
    <div class="settings-section danger-zone">
        <h2><i class="fas fa-exclamation-triangle"></i> Zone de danger</h2>
        
        <div class="setting-item">
            <div class="setting-info">
                <h3>Supprimer le compte</h3>
                <p class="text-danger">Cette action est irréversible et supprimera toutes vos données</p>
            </div>
            <button class="btn btn-danger" id="delete-account">
                <i class="fas fa-trash"></i>
                Supprimer le compte
            </button>
        </div>
    </div>
</div>

<!-- Modal changement nom d'utilisateur -->
<div id="change-username-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modifier le nom d'utilisateur</h3>
            <button class="modal-close" id="close-change-username">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="change-username-form">
            <div class="form-group">
                <label for="new-username">Nouveau nom d'utilisateur *</label>
                <input type="text" id="new-username" class="form-input" required minlength="3">
            </div>
            <div class="form-group">
                <label for="confirm-password-username">Mot de passe maître (confirmation) *</label>
                <input type="password" id="confirm-password-username" class="form-input" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-change-username">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Modifier
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal changement mot de passe maître -->
<div id="change-password-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Changer le mot de passe maître</h3>
            <button class="modal-close" id="close-change-password">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="change-password-form">
            <div class="form-group">
                <label for="current-password">Mot de passe actuel *</label>
                <input type="password" id="current-password" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="new-password">Nouveau mot de passe *</label>
                <input type="password" id="new-password" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmer le nouveau mot de passe *</label>
                <input type="password" id="confirm-password" class="form-input" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-change-password">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Modifier
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
// Éléments DOM
const changeUsernameBtn = document.getElementById('change-username');
const changeMasterPasswordBtn = document.getElementById('change-master-password');
const autoLockSelect = document.getElementById('auto-lock-time');
const logoutAllBtn = document.getElementById('logout-all-sessions');
const deleteAccountBtn = document.getElementById('delete-account');
const changeUsernameModal = document.getElementById('change-username-modal');
const changeUsernameForm = document.getElementById('change-username-form');
const changePasswordModal = document.getElementById('change-password-modal');
const changePasswordForm = document.getElementById('change-password-form');

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
    loadSettings();
});

// Chargement des informations utilisateur
async function loadUserInfo() {
    try {
        console.log('Chargement des infos utilisateur...');
        const response = await fetch('/api/user-info');
        console.log('Réponse API:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Données reçues:', data);
            const usernameElement = document.getElementById('username-display');
            if (usernameElement) {
                usernameElement.textContent = data.username || 'Utilisateur';
                console.log('Nom d\'utilisateur affiché:', data.username);
            }
        } else {
            console.error('Erreur API:', response.status);
            const errorData = await response.json();
            console.error('Détails erreur:', errorData);
        }
    } catch (error) {
        console.error('Erreur lors du chargement des infos utilisateur:', error);
        // Fallback: essayer de récupérer depuis le sessionStorage ou autre
        const usernameElement = document.getElementById('username-display');
        if (usernameElement) {
            usernameElement.textContent = 'Utilisateur';
        }
    }
}

// Chargement des paramètres
function loadSettings() {
    const autoLockTime = localStorage.getItem('autoLockTime') || '15';
    autoLockSelect.value = autoLockTime;
}

// Sauvegarde des paramètres
autoLockSelect.addEventListener('change', function() {
    localStorage.setItem('autoLockTime', this.value);
    showNotification('Paramètres sauvegardés', 'success');
});

// Changement nom d'utilisateur
changeUsernameBtn.addEventListener('click', function() {
    changeUsernameModal.style.display = 'block';
    document.getElementById('modal-overlay').style.display = 'block';
});

// Changement mot de passe maître
changeMasterPasswordBtn.addEventListener('click', function() {
    changePasswordModal.style.display = 'block';
    document.getElementById('modal-overlay').style.display = 'block';
});

// Déconnexion de toutes les sessions
logoutAllBtn.addEventListener('click', async function() {
    if (confirm('Êtes-vous sûr de vouloir vous déconnecter de toutes les sessions ?')) {
        try {
            const response = await fetch('/api/logout-all', { method: 'POST' });
            if (response.ok) {
                showNotification('Déconnecté de toutes les sessions', 'success');
                setTimeout(() => window.location.href = '/login', 1500);
            }
        } catch (error) {
            showNotification('Erreur lors de la déconnexion', 'error');
        }
    }
});

// Suppression du compte
deleteAccountBtn.addEventListener('click', function() {
    const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer la suppression de votre compte:');
    if (confirmation === 'SUPPRIMER') {
        deleteAccount();
    }
});

async function deleteAccount() {
    try {
        const response = await fetch('/api/delete-account', { method: 'DELETE' });
        if (response.ok) {
            showNotification('Compte supprimé', 'success');
            setTimeout(() => window.location.href = '/login', 1500);
        }
    } catch (error) {
        showNotification('Erreur lors de la suppression', 'error');
    }
}

// Gestion du formulaire de changement de nom d'utilisateur
changeUsernameForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newUsername = document.getElementById('new-username').value.trim();
    const confirmPassword = document.getElementById('confirm-password-username').value;
    
    if (newUsername.length < 3) {
        showNotification('Le nom d\'utilisateur doit contenir au moins 3 caractères', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/change-username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                new_username: newUsername,
                master_password: confirmPassword
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('Nom d\'utilisateur modifié avec succès', 'success');
            document.getElementById('username-display').textContent = newUsername;
            closeUsernameModal();
        } else {
            showNotification(result.error || 'Erreur lors de la modification', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
});

// Gestion du formulaire de changement de mot de passe
changePasswordForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (newPassword !== confirmPassword) {
        showNotification('Les mots de passe ne correspondent pas', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        showNotification('Le nouveau mot de passe doit contenir au moins 8 caractères', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/change-master-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('Mot de passe modifié avec succès. Déconnexion...', 'success');
            closeModal();
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            showNotification(result.error || 'Erreur lors de la modification', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
});

// Gestion des modals
document.getElementById('close-change-username').addEventListener('click', closeUsernameModal);
document.getElementById('cancel-change-username').addEventListener('click', closeUsernameModal);
document.getElementById('close-change-password').addEventListener('click', closeModal);
document.getElementById('cancel-change-password').addEventListener('click', closeModal);

function closeUsernameModal() {
    changeUsernameModal.style.display = 'none';
    document.getElementById('modal-overlay').style.display = 'none';
    changeUsernameForm.reset();
}

function closeModal() {
    changePasswordModal.style.display = 'none';
    document.getElementById('modal-overlay').style.display = 'none';
    changePasswordForm.reset();
}

// Notification simple
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 12px 20px; border-radius: 8px; color: white;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}
</script>
{% endblock %}
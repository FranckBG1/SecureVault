{% extends "layout.html" %}

{% block title %}SecureVault - Dashboard{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Mes mots de passe</h1>
    <button class="add-btn" id="add-password">
        <i class="fas fa-plus"></i>
        Ajouter un mot de passe
    </button>
</div>

<!-- Barre de recherche -->
<div class="search-container" style="margin-bottom: 20px;">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="Rechercher un mot de passe..."
               style="width: 100%; padding: 12px 15px 12px 40px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
    </div>
</div>

<div class="passwords-container">
    <!-- Indicateur de chargement -->
    <div id="loading-passwords" class="loading" style="padding: 40px;">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Chargement des mots de passe...</span>
    </div>

    <!-- Tableau des mots de passe -->
    <div class="passwords-table-container" id="passwords-table" style="display: none;">
        <table class="passwords-table">
            <thead>
            <tr>
                <th>Titre</th>
                <th>Nom d'utilisateur</th>
                <th>URL</th>
                <th>Dernière utilisation</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="passwords-tbody">
            <!-- Les données seront chargées ici -->
            </tbody>
        </table>
    </div>

    <!-- État vide -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">
            <i class="fas fa-lock"></i>
        </div>
        <h3>Aucun mot de passe enregistré</h3>
        <p>Commencez par ajouter votre premier mot de passe sécurisé</p>
        <button class="btn-primary" id="first-password">
            <i class="fas fa-plus"></i>
            Ajouter mon premier mot de passe
        </button>
    </div>

    <!-- État aucun résultat de recherche -->
    <div class="empty-state" id="no-results-state" style="display: none;">
        <div class="empty-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3>Aucun élément ne correspond</h3>
        <p>Aucun mot de passe ne correspond à votre recherche "<span id="search-term"></span>"</p>
        <button class="btn-primary" onclick="clearSearch()">
            <i class="fas fa-times"></i>
            Effacer la recherche
        </button>
    </div>
</div>

<!-- Modal pour ajouter/modifier un mot de passe -->
<div id="password-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Ajouter un mot de passe</h3>
            <button class="modal-close" id="close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="password-form" class="password-form">
            <div class="form-group">
                <label for="password-title">Titre *</label>
                <input type="text" id="password-title" class="form-input" placeholder="Ex: Gmail, Facebook, Site web..."
                       required>
            </div>

            <div class="form-group">
                <label for="password-url">URL (optionnel)</label>
                <input type="url" id="password-url" class="form-input" placeholder="https://example.com">
            </div>

            <div class="form-group">
                <label for="password-username">Nom d'utilisateur / Email</label>
                <input type="text" id="password-username" class="form-input" placeholder="votre.email@example.com">
            </div>

            <div class="form-group">
                <label for="password-password">Mot de passe *</label>
                <div class="password-input-group">
                    <input type="password" id="password-password" class="form-input" placeholder="Votre mot de passe"
                           required>
                    <button type="button" class="toggle-visibility" id="toggle-password-visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="copy-btn-small" id="copy-password-modal" title="Copier le mot de passe">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button type="button" class="generate-btn-small" id="generate-password-modal">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
                <!-- Message de masquage temporaire -->
                <div id="password-copy-message" class="password-copy-message" style="display: none;">
                    <i class="fas fa-clock"></i>
                    <span id="copy-message-text">Mot de passe visible - se cache dans <span id="countdown">10</span>s</span>
                </div>
            </div>

            <!-- Indicateur de force du mot de passe -->
            <div class="password-strength-modal" id="password-strength-modal" style="display: none;">
                <div class="strength-label">Force du mot de passe:</div>
                <div class="strength-bar">
                    <div class="strength-fill" id="modal-strength-fill"></div>
                </div>
                <div class="strength-text" id="modal-strength-text"></div>
            </div>

            <div class="form-group">
                <label for="password-notes">Notes (optionnel)</label>
                <textarea id="password-notes" class="form-input" rows="3"
                          placeholder="Notes ou informations supplémentaires..."></textarea>
            </div>

            <div class="form-group">
                <label for="password-tags">Tags (optionnel)</label>
                <input type="text" id="password-tags" class="form-input"
                       placeholder="travail, personnel, social... (séparés par des virgules)">
                <small class="form-help">Séparez les tags par des virgules pour organiser vos mots de passe</small>
            </div>

            <!-- Demande du mot de passe maître -->
            <div class="form-group master-password-group">
                <label for="master-password-modal-input">Mot de passe maître * (pour chiffrer)</label>
                <input type="password" id="master-password-modal-input" class="form-input"
                       placeholder="Votre mot de passe maître" required>
                <small class="form-help">Nécessaire pour chiffrer vos données de manière sécurisée</small>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-password">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary" id="save-password">
                    <i class="fas fa-save"></i>
                    <span id="save-text">Enregistrer</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal pour demander le mot de passe maître -->
<div id="master-password-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Mot de passe maître requis</h3>
            <button class="modal-close" id="close-master-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="master-password-form">
            <div class="form-group">
                <label for="master-password-input">Entrez votre mot de passe maître pour accéder à ce mot de passe :</label>
                <input type="password" id="master-password-input" class="form-input" placeholder="Votre mot de passe maître" required autofocus>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-master-password">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary" id="confirm-master-password">
                    <i class="fas fa-unlock"></i>
                    <span id="confirm-text">Confirmer</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal pour confirmer la suppression -->
<div id="delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Confirmer la suppression</h3>
            <button class="modal-close" id="close-delete-confirm-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body" style="padding: 20px; text-align: center;">
            <div style="color: #e74c3c; font-size: 48px; margin-bottom: 16px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4 style="margin-bottom: 12px;">Supprimer ce mot de passe ?</h4>
            <p style="color: #666; margin-bottom: 0;">
                Cette action est irréversible. Le mot de passe "<strong id="delete-password-title"></strong>" sera définitivement supprimé.
            </p>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-delete">
                <i class="fas fa-times"></i>
                Annuler
            </button>
            <button type="button" class="btn btn-danger" id="confirm-delete" style="background-color: #e74c3c;">
                <i class="fas fa-trash"></i>
                <span id="delete-text">Supprimer</span>
            </button>
        </div>
    </div>
</div>

<!-- Overlay pour la modal de suppression -->
<div id="delete-modal-overlay" class="modal-overlay" style="display: none;"></div>

<!-- Overlay pour la modal du mot de passe maître -->
<div id="master-modal-overlay" class="modal-overlay" style="display: none;"></div>

<!-- Overlay pour la modal -->
<div id="modal-overlay" class="modal-overlay" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    // Variables globales
    let passwords = [];
    let editingPasswordId = null;
    let passwordVisibilityTimeout = null;
    let countdownInterval = null;
    let pendingPasswordId = null; // Pour stocker l'ID du mot de passe en attente

    // Éléments DOM
    const loadingElement = document.getElementById('loading-passwords');
    const tableElement = document.getElementById('passwords-table');
    const emptyStateElement = document.getElementById('empty-state');
    const noResultsStateElement = document.getElementById('no-results-state');
    const passwordsTableBody = document.getElementById('passwords-tbody');
    const searchInput = document.getElementById('search-input');
    const addPasswordBtn = document.getElementById('add-password');
    const firstPasswordBtn = document.getElementById('first-password');
    const logoutBtn = document.getElementById('logout-btn');
    const passwordModal = document.getElementById('password-modal');
    const passwordForm = document.getElementById('password-form');
    const savePasswordBtn = document.getElementById('save-password');
    const passwordTitleInput = document.getElementById('password-title');
    const passwordUrlInput = document.getElementById('password-url');
    const passwordUsernameInput = document.getElementById('password-username');
    const passwordPasswordInput = document.getElementById('password-password');
    const passwordNotesInput = document.getElementById('password-notes');
    const passwordTagsInput = document.getElementById('password-tags');
    const masterPasswordModalInput = document.getElementById('master-password-modal-input'); // Corrigé
    const modalStrengthFill = document.getElementById('modal-strength-fill');
    const modalStrengthText = document.getElementById('modal-strength-text');

    // Éléments pour la modal du mot de passe maître
    const masterPasswordForm = document.getElementById('master-password-form');
    const masterPasswordInput = document.getElementById('master-password-input');
    const confirmMasterPasswordBtn = document.getElementById('confirm-master-password');

    // Éléments pour la modal de confirmation de suppression
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const cancelDeleteBtn = document.getElementById('cancel-delete');

    // Chargement des mots de passe
    async function loadPasswords() {
        try {
            showLoading();
            const response = await fetch('/api/passwords');

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Erreur ${response.status}`);
            }

            const data = await response.json();
            passwords = data.passwords || [];
            displayPasswords(passwords);

        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            hideLoading();
            showError('Erreur lors du chargement des mots de passe');
        }
    }

    // Affichage des mots de passe
    function displayPasswords(passwordList) {
        hideLoading();

        if (passwordList.length === 0) {
            showEmptyState();
            return;
        }

        showTable();
        passwordsTableBody.innerHTML = '';

        passwordList.forEach(password => {
            const row = createPasswordRow(password);
            passwordsTableBody.appendChild(row);
        });
    }

    // Création d'une ligne de mot de passe
    function createPasswordRow(password) {
        const row = document.createElement('tr');
        row.className = 'password-row';

        const lastUsed = password.last_used ?
            new Date(password.last_used).toLocaleDateString('fr-FR') :
            'Jamais utilisé';

        row.innerHTML = `
            <td>
                <strong>${escapeHtml(password.title)}</strong>
                ${password.tags && password.tags.length > 0 ?
            '<div style="margin-top: 4px;">' +
            password.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 4px;">${escapeHtml(tag)}</span>`).join('') +
            '</div>' : ''}
            </td>
            <td>${escapeHtml(password.username || '-')}</td>
            <td>${password.url ? `<a href="${escapeHtml(password.url)}" target="_blank" style="color: #667eea; text-decoration: none;">${escapeHtml(password.url)}</a>` : '-'}</td>
            <td>${lastUsed}</td>
            <td class="actions-cell">
                <button class="action-btn edit-btn" title="Modifier" onclick="editPassword(${password.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" title="Supprimer" onclick="confirmDeletePassword(${password.id}, '${escapeHtml(password.title)}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        return row;
    }

    // Fonctions d'affichage
    function showLoading() {
        loadingElement.style.display = 'flex';
        tableElement.style.display = 'none';
        emptyStateElement.style.display = 'none';
        noResultsStateElement.style.display = 'none';
    }

    function hideLoading() {
        loadingElement.style.display = 'none';
    }

    function showTable() {
        tableElement.style.display = 'block';
        emptyStateElement.style.display = 'none';
        noResultsStateElement.style.display = 'none';
    }

    function showEmptyState() {
        tableElement.style.display = 'none';
        emptyStateElement.style.display = 'block';
        noResultsStateElement.style.display = 'none';
    }

    function showNoResultsState(searchTerm) {
        tableElement.style.display = 'none';
        emptyStateElement.style.display = 'none';
        noResultsStateElement.style.display = 'block';
        document.getElementById('search-term').textContent = searchTerm;
    }

    function showError(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #e74c3c; color: white; padding: 12px 20px;
            border-radius: 8px; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        document.body.appendChild(notification);

        setTimeout(() => {
            document.body.removeChild(notification);
        }, 5000);
    }

    function showSuccessNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #27ae60; color: white; padding: 12px 20px;
            border-radius: 8px; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        document.body.appendChild(notification);

        setTimeout(() => {
            document.body.removeChild(notification);
        }, 3000);
    }

    // Fonctions de gestion des mots de passe
    async function editPassword(passwordId) {
        pendingPasswordId = passwordId;
        showMasterPasswordModal();
    }

    // Gestion de la modal du mot de passe maître
    function showMasterPasswordModal() {
        document.getElementById('master-password-modal').style.display = 'block';
        document.getElementById('master-modal-overlay').style.display = 'block';
        masterPasswordInput.value = '';
        masterPasswordInput.focus();
    }

    function closeMasterPasswordModal() {
        document.getElementById('master-password-modal').style.display = 'none';
        document.getElementById('master-modal-overlay').style.display = 'none';
        pendingPasswordId = null;
        masterPasswordInput.value = '';
    }

    // Soumettre le mot de passe maître
    async function handleMasterPasswordSubmit(event) {
        event.preventDefault();

        const masterPassword = masterPasswordInput.value;
        if (!masterPassword) {
            showError('Le mot de passe maître est requis');
            masterPasswordInput.focus();
            return;
        }

        if (!pendingPasswordId) {
            showError('Aucun mot de passe sélectionné');
            return;
        }

        confirmMasterPasswordBtn.disabled = true;
        document.getElementById('confirm-text').textContent = 'Vérification...';

        try {
            const response = await fetch(`/api/passwords/${pendingPasswordId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Password': masterPassword
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    showError('Mot de passe maître incorrect');
                    masterPasswordInput.focus();
                    return;
                }
                throw new Error('Erreur lors de la récupération du mot de passe');
            }

            const passwordData = await response.json();

            // Fermer la modal du mot de passe maître
            closeMasterPasswordModal();

            // Ouvrir la modal d'édition avec les données
            editingPasswordId = pendingPasswordId;
            openPasswordModalForEdit(passwordData);

        } catch (error) {
            console.error('Erreur lors de l\'édition:', error);
            showError('Erreur lors de la récupération du mot de passe');
        } finally {
            confirmMasterPasswordBtn.disabled = false;
            document.getElementById('confirm-text').textContent = 'Confirmer';
        }
    }

    // Confirmer la suppression d'un mot de passe
    function confirmDeletePassword(passwordId, passwordTitle) {
        pendingPasswordId = passwordId;
        document.getElementById('delete-password-title').textContent = passwordTitle;
        deleteConfirmModal.style.display = 'block';
        document.getElementById('delete-modal-overlay').style.display = 'block';
    }

    function closeDeleteConfirmModal() {
        deleteConfirmModal.style.display = 'none';
        document.getElementById('delete-modal-overlay').style.display = 'none';
        pendingPasswordId = null;
    }

    // Soumettre la suppression
    async function handleDeleteConfirm() {
        if (!pendingPasswordId) return;

        confirmDeleteBtn.disabled = true;
        document.getElementById('delete-text').textContent = 'Suppression...';

        try {
            const response = await fetch(`/api/passwords/${pendingPasswordId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Erreur lors de la suppression');
            }

            showSuccessNotification('Mot de passe supprimé !');
            loadPasswords();

            // Fermer la modal de confirmation
            closeDeleteConfirmModal();

        } catch (error) {
            console.error('Erreur lors de la suppression:', error);
            showError('Erreur lors de la suppression');
        } finally {
            confirmDeleteBtn.disabled = false;
            document.getElementById('delete-text').textContent = 'Supprimer';
        }
    }

    async function logout() {
        try {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/login';
        } catch (error) {
            console.error('Erreur lors de la déconnexion:', error);
            window.location.href = '/login';
        }
    }

    // Recherche
    function filterPasswords() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            displayPasswords(passwords);
            return;
        }

        const filtered = passwords.filter(password =>
            password.title.toLowerCase().includes(searchTerm) ||
            (password.username && password.username.toLowerCase().includes(searchTerm)) ||
            (password.url && password.url.toLowerCase().includes(searchTerm))
        );

        if (filtered.length === 0) {
            showNoResultsState(searchTerm);
        } else {
            displayPasswords(filtered);
        }
    }

    function clearSearch() {
        searchInput.value = '';
        displayPasswords(passwords);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Gestion de la modal
    function openPasswordModal() {
        editingPasswordId = null;
        passwordModal.style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('modal-title').textContent = 'Ajouter un mot de passe';
        document.getElementById('save-text').textContent = 'Enregistrer';
        passwordForm.reset();
        document.getElementById('password-strength-modal').style.display = 'none';
        passwordTitleInput.focus();
    }

    function closePasswordModal() {
        passwordModal.style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        editingPasswordId = null;
    }

    function openPasswordModalForEdit(passwordData) {
        // S'assurer que editingPasswordId est défini avant d'ouvrir la modal
        if (!editingPasswordId && passwordData.id) {
            editingPasswordId = passwordData.id;
        }

        passwordModal.style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('modal-title').textContent = 'Modifier le mot de passe';
        document.getElementById('save-text').textContent = 'Mettre à jour';

        passwordTitleInput.value = passwordData.title;
        passwordUrlInput.value = passwordData.url || '';
        passwordUsernameInput.value = passwordData.username || '';
        passwordPasswordInput.value = passwordData.password || ''; // Afficher le mot de passe s'il existe
        passwordNotesInput.value = passwordData.notes || '';
        passwordTagsInput.value = passwordData.tags ? passwordData.tags.join(', ') : '';
        masterPasswordModalInput.value = '';

        // Analyser la force du mot de passe s'il existe
        if (passwordData.password) {
            analyzePasswordStrengthInModal(passwordData.password);
        } else {
            document.getElementById('password-strength-modal').style.display = 'none';
        }

        passwordTitleInput.focus();
    }

    // Basculer la visibilité du mot de passe avec message temporaire
    function togglePasswordVisibility() {
        const isPassword = passwordPasswordInput.type === 'password';

        if (isPassword) {
            showPasswordTemporarily();
        } else {
            hidePasswordAgain();
        }
    }

    function showPasswordTemporarily() {
        const copyMessage = document.getElementById('password-copy-message');
        const countdownElement = document.getElementById('countdown');

        passwordPasswordInput.type = 'text';
        document.getElementById('toggle-password-visibility').innerHTML = '<i class="fas fa-eye-slash"></i>';
        copyMessage.style.display = 'block';

        let remainingSeconds = 10;
        countdownElement.textContent = remainingSeconds;

        if (passwordVisibilityTimeout) clearTimeout(passwordVisibilityTimeout);
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
            remainingSeconds--;
            countdownElement.textContent = remainingSeconds;

            if (remainingSeconds <= 0) {
                clearInterval(countdownInterval);
                hidePasswordAgain();
            }
        }, 1000);

        passwordVisibilityTimeout = setTimeout(() => {
            hidePasswordAgain();
        }, 10000);
    }

    function hidePasswordAgain() {
        passwordPasswordInput.type = 'password';
        document.getElementById('toggle-password-visibility').innerHTML = '<i class="fas fa-eye"></i>';
        document.getElementById('password-copy-message').style.display = 'none';

        if (passwordVisibilityTimeout) {
            clearTimeout(passwordVisibilityTimeout);
            passwordVisibilityTimeout = null;
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }

    // Copier le mot de passe
    function copyPasswordFromModal() {
        const password = passwordPasswordInput.value;
        if (!password) {
            showError('Aucun mot de passe à copier');
            return;
        }

        navigator.clipboard.writeText(password).then(() => {
            showSuccessNotification('Mot de passe copié dans le presse-papiers !');
        }).catch(err => {
            console.error('Erreur lors de la copie:', err);
            showError('Impossible de copier le mot de passe');
        });
    }

    // Générer un mot de passe
    async function generatePasswordInModal() {
        try {
            const options = {
                length: 16,
                use_uppercase: true,
                use_lowercase: true,
                use_digits: true,
                use_special: true,
                exclude_similar: true
            };

            const response = await fetch('/api/generate-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(options)
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Erreur lors de la génération');
            }

            const data = await response.json();
            passwordPasswordInput.value = data.password;
            analyzePasswordStrengthInModal(data.password);
            showSuccessNotification('Mot de passe généré !');

        } catch (error) {
            console.error('Erreur génération:', error);
            showError('Erreur lors de la génération du mot de passe');
        }
    }

    // Analyser la force du mot de passe
    async function analyzePasswordStrengthInModal(password) {
        const strengthContainer = document.getElementById('password-strength-modal');

        if (!password) {
            strengthContainer.style.display = 'none';
            return;
        }

        strengthContainer.style.display = 'block';

        try {
            const response = await fetch('/api/check-password-strength', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({password: password})
            });

            if (response.ok) {
                const data = await response.json();
                const strength = data.strength;

                modalStrengthFill.style.width = strength.score + '%';
                modalStrengthText.textContent = `${strength.level} (${strength.score}%)`;

                modalStrengthFill.className = 'strength-fill';
                if (strength.score >= 80) modalStrengthFill.classList.add('very-strong');
                else if (strength.score >= 60) modalStrengthFill.classList.add('strong');
                else if (strength.score >= 40) modalStrengthFill.classList.add('medium');
                else if (strength.score >= 20) modalStrengthFill.classList.add('weak');
                else modalStrengthFill.classList.add('very-weak');
            }

        } catch (error) {
            console.error('Erreur analyse force:', error);
        }
    }

    // Soumettre le formulaire
    async function handlePasswordFormSubmit(event) {
        event.preventDefault();

        const formData = {
            title: passwordTitleInput.value.trim(),
            url: passwordUrlInput.value.trim(),
            username: passwordUsernameInput.value.trim(),
            password: passwordPasswordInput.value,
            notes: passwordNotesInput.value.trim(),
            tags: passwordTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag),
            master_password: masterPasswordModalInput.value
        };

        if (!formData.title) {
            showError('Le titre est requis');
            passwordTitleInput.focus();
            return;
        }

        if (!formData.password) {
            showError('Le mot de passe est requis');
            passwordPasswordInput.focus();
            return;
        }

        if (!formData.master_password) {
            showError('Le mot de passe maître est requis pour chiffrer vos données');
            masterPasswordModalInput.focus();
            return;
        }

        savePasswordBtn.disabled = true;

        try {
            let response;
            let successMessage;

            if (editingPasswordId) {
                document.getElementById('save-text').textContent = 'Mise à jour...';
                response = await fetch(`/api/passwords/${editingPasswordId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                successMessage = 'Mot de passe mis à jour avec succès !';
            } else {
                document.getElementById('save-text').textContent = 'Enregistrement...';
                response = await fetch('/api/passwords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                successMessage = 'Mot de passe ajouté avec succès !';
            }

            const data = await response.json();

            if (response.ok) {
                closePasswordModal();
                showSuccessNotification(successMessage);
                loadPasswords();
            } else {
                showError(data.error || 'Erreur lors de l\'opération');
            }

        } catch (error) {
            console.error('Erreur lors de l\'opération:', error);
            showError('Erreur de communication avec le serveur');
        } finally {
            savePasswordBtn.disabled = false;
            if (editingPasswordId) {
                document.getElementById('save-text').textContent = 'Mettre à jour';
            } else {
                document.getElementById('save-text').textContent = 'Enregistrer';
            }
        }
    }

    // Event Listeners
    addPasswordBtn.addEventListener('click', openPasswordModal);
    firstPasswordBtn.addEventListener('click', openPasswordModal);
    document.getElementById('close-modal').addEventListener('click', closePasswordModal);
    document.getElementById('modal-overlay').addEventListener('click', closePasswordModal);
    document.getElementById('cancel-password').addEventListener('click', closePasswordModal);
    passwordForm.addEventListener('submit', handlePasswordFormSubmit);
    document.getElementById('toggle-password-visibility').addEventListener('click', togglePasswordVisibility);
    document.getElementById('generate-password-modal').addEventListener('click', generatePasswordInModal);
    document.getElementById('copy-password-modal').addEventListener('click', copyPasswordFromModal);

    // Event Listeners pour la modal du mot de passe maître
    document.getElementById('close-master-modal').addEventListener('click', closeMasterPasswordModal);
    document.getElementById('master-modal-overlay').addEventListener('click', closeMasterPasswordModal);
    document.getElementById('cancel-master-password').addEventListener('click', closeMasterPasswordModal);
    masterPasswordForm.addEventListener('submit', handleMasterPasswordSubmit);

    // Event Listeners pour la modal de confirmation de suppression
    document.getElementById('close-delete-confirm-modal').addEventListener('click', closeDeleteConfirmModal);
    document.getElementById('delete-modal-overlay').addEventListener('click', closeDeleteConfirmModal);
    cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
    confirmDeleteBtn.addEventListener('click', handleDeleteConfirm);

    passwordPasswordInput.addEventListener('input', (e) => {
        analyzePasswordStrengthInModal(e.target.value);
    });

    passwordTagsInput.addEventListener('blur', () => {
        const tags = passwordTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
        passwordTagsInput.value = tags.join(', ');
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (document.getElementById('master-password-modal').style.display === 'block') {
                closeMasterPasswordModal();
            } else if (passwordModal.style.display === 'block') {
                closePasswordModal();
            } else if (deleteConfirmModal.style.display === 'block') {
                closeDeleteConfirmModal();
            }
        }
    });

    searchInput.addEventListener('input', filterPasswords);
    logoutBtn.addEventListener('click', logout);

    // Initialisation
    window.addEventListener('load', () => {
        loadPasswords();
    });
</script>
{% endblock %}

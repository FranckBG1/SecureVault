{% extends "layout.html" %}

{% block title %}SecureVault - Dashboard{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block content %}
            <div class="content-header">
                <h1>Mes mots de passe</h1>
                <button class="add-btn" id="add-password">
                    <i class="fas fa-plus"></i>
                    Ajouter un mot de passe
                </button>
            </div>

            <!-- Barre de recherche -->
            <div class="search-container" style="margin-bottom: 20px;">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Rechercher un mot de passe..." style="width: 100%; padding: 12px 15px 12px 40px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                </div>
            </div>

            <div class="passwords-container">
                <!-- Indicateur de chargement -->
                <div id="loading-passwords" class="loading" style="padding: 40px;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Chargement des mots de passe...</span>
                </div>

                <!-- Tableau des mots de passe -->
                <div class="passwords-table-container" id="passwords-table" style="display: none;">
                    <table class="passwords-table">
                        <thead>
                            <tr>
                                <th>Titre</th>
                                <th>Nom d'utilisateur</th>
                                <th>URL</th>
                                <th>Dernière utilisation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="passwords-tbody">
                            <!-- Les données seront chargées ici -->
                        </tbody>
                    </table>
                </div>

                <!-- État vide -->
                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Aucun mot de passe enregistré</h3>
                    <p>Commencez par ajouter votre premier mot de passe sécurisé</p>
                    <button class="btn-primary" id="first-password">
                        <i class="fas fa-plus"></i>
                        Ajouter mon premier mot de passe
                    </button>
                </div>
            </div>
{% endblock %}

{% block scripts %}
<script>
        // Variables globales
        let passwords = [];
        let currentUser = null;

        // Éléments DOM
        const loadingElement = document.getElementById('loading-passwords');
        const tableElement = document.getElementById('passwords-table');
        const emptyStateElement = document.getElementById('empty-state');
        const passwordsTableBody = document.getElementById('passwords-tbody');
        const searchInput = document.getElementById('search-input');
        const addPasswordBtn = document.getElementById('add-password');
        const firstPasswordBtn = document.getElementById('first-password');
        const logoutBtn = document.getElementById('logout-btn');

        // Vérification de l'authentification
        async function checkAuthentication() {
            loadPasswords();
        }

        // Chargement des mots de passe
        async function loadPasswords() {
            try {
                showLoading();

                const response = await fetch('/api/passwords');

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Erreur ${response.status}`);
                }

                const data = await response.json();
                passwords = data.passwords || [];

                displayPasswords(passwords);

            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                hideLoading();
                showError('Erreur lors du chargement des mots de passe');
            }
        }

        // Affichage des mots de passe
        function displayPasswords(passwordList) {
            hideLoading();

            if (passwordList.length === 0) {
                showEmptyState();
                return;
            }

            showTable();

            passwordsTableBody.innerHTML = '';

            passwordList.forEach(password => {
                const row = createPasswordRow(password);
                passwordsTableBody.appendChild(row);
            });
        }

        // Création d'une ligne de mot de passe
        function createPasswordRow(password) {
            const row = document.createElement('tr');
            row.className = 'password-row';

            const lastUsed = password.last_used ?
                new Date(password.last_used).toLocaleDateString('fr-FR') :
                'Jamais utilisé';

            row.innerHTML = `
                <td>
                    <strong>${escapeHtml(password.title)}</strong>
                    ${password.tags && password.tags.length > 0 ?
                        '<div style="margin-top: 4px;">' +
                        password.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 4px;">${escapeHtml(tag)}</span>`).join('') +
                        '</div>' : ''}
                </td>
                <td>${escapeHtml(password.username || '-')}</td>
                <td>${password.url ? `<a href="${escapeHtml(password.url)}" target="_blank" style="color: #667eea; text-decoration: none;">${escapeHtml(password.url)}</a>` : '-'}</td>
                <td>${lastUsed}</td>
                <td class="actions-cell">
                    <button class="action-btn copy-btn" title="Copier le mot de passe" onclick="copyPassword(${password.id})">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn edit-btn" title="Modifier" onclick="editPassword(${password.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" title="Supprimer" onclick="deletePassword(${password.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            return row;
        }

        // Fonctions d'affichage
        function showLoading() {
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            emptyStateElement.style.display = 'none';
        }

        function hideLoading() {
            loadingElement.style.display = 'none';
        }

        function showTable() {
            tableElement.style.display = 'block';
            emptyStateElement.style.display = 'none';
        }

        function showEmptyState() {
            tableElement.style.display = 'none';
            emptyStateElement.style.display = 'block';
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: #e74c3c; color: white; padding: 12px 20px;
                border-radius: 8px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Fonctions de gestion des mots de passe
        async function copyPassword(passwordId) {
            const masterPassword = prompt('Entrez votre mot de passe maître pour accéder à ce mot de passe :');
            if (!masterPassword) return;

            try {
                const response = await fetch(`/api/passwords/${passwordId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ master_password: masterPassword })
                });

                if (!response.ok) {
                    throw new Error('Mot de passe maître incorrect');
                }

                const data = await response.json();

                await navigator.clipboard.writeText(data.password);
                showSuccessNotification('Mot de passe copié !');

            } catch (error) {
                console.error('Erreur lors de la copie:', error);
                showError('Erreur lors de la copie du mot de passe');
            }
        }

        function editPassword(passwordId) {
            alert('Fonctionnalité d\'édition à venir');
        }

        async function deletePassword(passwordId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce mot de passe ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/passwords/${passwordId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la suppression');
                }

                showSuccessNotification('Mot de passe supprimé !');
                loadPasswords();

            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showError('Erreur lors de la suppression');
            }
        }

        // Déconnexion
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erreur lors de la déconnexion:', error);
                window.location.href = '/login';
            }
        }

        // Recherche
        function filterPasswords() {
            const searchTerm = searchInput.value.toLowerCase().trim();

            if (!searchTerm) {
                displayPasswords(passwords);
                return;
            }

            const filtered = passwords.filter(password =>
                password.title.toLowerCase().includes(searchTerm) ||
                (password.username && password.username.toLowerCase().includes(searchTerm)) ||
                (password.url && password.url.toLowerCase().includes(searchTerm))
            );

            displayPasswords(filtered);
        }

        // Utilitaires
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: #27ae60; color: white; padding: 12px 20px;
                border-radius: 8px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Event Listeners
        searchInput.addEventListener('input', filterPasswords);
        addPasswordBtn.addEventListener('click', () => {
            alert('Fonctionnalité d\'ajout à venir');
        });
        firstPasswordBtn.addEventListener('click', () => {
            alert('Fonctionnalité d\'ajout à venir');
        });
        logoutBtn.addEventListener('click', logout);

        // Initialisation
        window.addEventListener('load', () => {
            checkAuthentication();
        });
</script>
{% endblock %}
